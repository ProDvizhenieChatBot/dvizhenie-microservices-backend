# Бэкенд для MVP благотворительного фонда "Движение Жизни"

Этот проект представляет собой бэкенд-систему, реализованную на микросервисной архитектуре, для автоматизации сбора заявок от подопечных через чат-бота в Telegram.

## Оглавление

- [Технологический стек](#технологический-стек)
- [Требования](#требования)
- [Быстрый старт](#быстрый-старт)
- [Доступ к сервисам](#доступ-к-сервисам)
- [Процесс загрузки файлов](#процесс-загрузки-файлов)
- [Разработка](#разработка)
  - [Pre-commit хуки](#pre-commit-хуки)
- [Конфигурация (.env)](#конфигурация-env)
- [Структура проекта](#структура-проекта)

## Технологический стек

*   **Язык:** Python 3.12
*   **Фреймворки:** FastAPI (для API), Aiogram 3 (для Telegram-бота)
*   **База данных:** PostgreSQL
*   **Хранилище файлов:** MinIO (S3-совместимое)
*   **Оркестрация:** Docker, Docker Compose
*   **Веб-сервер/API Gateway:** Nginx
*   **Инструменты разработки:** Ruff, Pyright, Pre-commit, UV
*   **Тестирование и визуализация:** Postman, DBeaver, Pytest 

## Требования

Для запуска и работы с проектом вам понадобятся:

*   **Docker**
*   **Docker Compose**
*   **Git**

Для локальной разработки также рекомендуется установить:
*   [uv](https://github.com/astral-sh/uv) (быстрый менеджер пакетов Python)
*   [pre-commit](https://pre-commit.com/) (для запуска проверок перед коммитом)

## Быстрый старт

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/ProDvizhenieChatBot/dvizhenie-microservices-backend.git
    cd dvizhenie-microservices-backend
    ```

2.  **Создайте файл конфигурации:**
    Скопируйте файл с примером переменных окружения.
    ```bash
    cp .env.example .env
    ```

3.  **Заполните `.env` файл:**
    Откройте файл `.env` в текстовом редакторе и обязательно заполните следующие переменные:
    *   `TELEGRAM_BOT_TOKEN`: Укажите токен вашего Telegram-бота.
    *   `MINI_APP_URL`: Укажите URL, на котором будет размещено ваше веб-приложение (Mini App).

4.  **Соберите и запустите контейнеры:**
    Эта команда скачает образы, соберет ваши сервисы и запустит их в фоновом режиме. Для применения изменений в Nginx, пересоберите его образ.
    ```bash
    docker-compose up -d --build
    ```

После выполнения этих шагов вся система будет запущена и готова к работе.

## Доступ к сервисам

После успешного запуска сервисы будут доступны по следующим адресам:

*   **API Gateway (Nginx):** `http://localhost:8000`
    *   Все запросы к API (`/api/...`) проходят через этот шлюз.
*   **MinIO Console (веб-интерфейс для файлов):** `http://localhost:9001`
    *   **Логин:** `minioadmin` (или значение `MINIO_ROOT_USER` из `.env`)
    *   **Пароль:** `minioadmin` (или значение `MINIO_ROOT_PASSWORD` из `.env`)
*   **Telegram Бот:**
    *   Найдите вашего бота в Telegram и отправьте ему команду `/start`.

### Документация API (Swagger/ReDoc)

*   **Динамическая документация `api-service`:**
    *   Swagger UI: `http://localhost:8000/docs`
    *   ReDoc: `http://localhost:8000/redoc`

*   **Динамическая документация `file-storage-service`:**
    *   Swagger UI: `http://localhost:8002/docs`
    *   ReDoc: `http://localhost:8002/redoc`
    *   *Примечание: Этот порт открыт для удобства разработки.*

### Руководство по редактированию анкеты

Для администраторов и менеджеров фонда доступно руководство, объясняющее, как устроена и как редактировать JSON-схему анкеты. Это позволяет изменять вопросы, варианты ответов и логику анкеты без необходимости привлекать разработчиков.

## Разработка

### Pre-commit хуки

В проекте настроены pre-commit хуки для автоматической проверки и форматирования кода перед каждым коммитом. Это обеспечивает единый стиль кода и помогает избежать простых ошибок.

1.  **Установка (один раз для проекта):**
    После установки `pre-commit` глобально, выполните в корне проекта:
    ```bash
    pre-commit install
    ```

2.  **Использование:**
    Теперь, при каждой попытке `git commit`, будут автоматически запускаться `ruff` (форматирование и линтинг) и `pyright` (проверка типов). Если хуки найдут ошибки, коммит будет прерван. Исправьте ошибки и повторите коммит.

3.  **Ручной запуск:**
    Вы можете запустить все проверки для всех файлов в любой момент:
    ```bash
    pre-commit run --all-files
    ```

## Конфигурация (.env)

Основные переменные, которые можно настроить в файле `.env`:

*   `POSTGRES_*`: Настройки для подключения к базе данных PostgreSQL.
*   `TELEGRAM_BOT_TOKEN`: Секретный токен для вашего Telegram-бота.
*   `MINI_APP_URL`: URL для кнопки Mini App, которую бот отправляет пользователю.
*   `API_SERVICE_URL`: Внутренний адрес API-сервиса, используемый ботом.
*   `MINIO_*`: Учетные данные и название бакета для S3-хранилища MinIO.

## Структура проекта

*   `services/`: Основная директория, содержащая код каждого микросервиса.
    *   `api_service/`: Сервис с основной бизнес-логикой, управлением заявками и пользователями.
    *   `bot_service/`: Сервис, отвечающий за взаимодействие с Telegram Bot API.
    *   `file_storage_service/`: Сервис для загрузки и скачивания файлов в MinIO.
*   `nginx/`: Конфигурация для Nginx, который выступает в роли API Gateway.
*   `docker-compose.yml`: Файл для оркестрации и запуска всех сервисов проекта.
*   `.env.example`: Шаблон с необходимыми переменными окружения.
*   `.pre-commit-config.yaml`: Конфигурация для pre-commit хуков.

## Процесс загрузки файлов(воркфлоу)

Загрузка файла и его привязка к заявке происходит в два этапа, так как за эти операции отвечают разные микросервисы.

**Шаг 1: Загрузка файла в `file-storage-service`**

Клиент (Mini App) отправляет файл напрямую в сервис хранения файлов.

*   **Запрос:** `POST http://localhost:8000/api/v1/files/upload`
*   **Тело:** `multipart/form-data` с полем `file`.
*   **Ответ (`201 Created`):** Сервис сохраняет файл в MinIO и возвращает его уникальный ID.
    ```json
    {
      "file_id": "a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890.pdf",
      "filename": "passport_scan.pdf",
      "content_type": "application/pdf"
    }
    ```

**Шаг 2: Привязка файла к заявке в `api-service`**

Получив `file_id`, клиент отправляет его в основной API-сервис, чтобы создать связь между файлом и конкретной заявкой.

*   **Запрос:** `POST http://localhost:8000/api/v1/applications/{application_uuid}/files`
*   **Тело (`application/json`):**
    ```json
    {
      "file_id": "a1b2c3d4-e5f6-7890-a1b2-c3d4e5f67890.pdf",
      "original_filename": "passport_scan.pdf",
      "form_field_id": "beneficiary_passport_scan"
    }
    ```
*   **Ответ (`201 Created`):** Сервис создает запись в базе данных, связывая `application_uuid` с `file_id`.