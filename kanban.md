### **Общая стратегия и параллельная работа**

Базовая инфраструктура (Docker, Nginx, пустые сервисы) готова. **Фаза 1 завершена.**

Мы переходим к **Фазе 2**, которая является ключевой. Основная задача — рефакторинг моделей данных для поддержки UUID, сессий Telegram и загрузки файлов. После завершения рефакторинга базы данных (Эпик 3.2), работа над эндпоинтами для админов (3.3) и для пользователей (3.4) может вестись параллельно.

---
### **Фаза 1: Реализация базовой логики сервисов [DONE]**

Эта фаза успешно завершена. Были реализованы следующие ключевые возможности:
*   **API Service:** Созданы базовые эндпоинты для создания черновика заявки (`POST`), сохранения прогресса (`PATCH`) и получения данных (`GET`) с использованием целочисленных ID.
*   **File Storage Service:** Реализована полная логика загрузки файлов в MinIO и генерации временных pre-signed URL для их скачивания.
*   **Инфраструктура:** Настроена вся необходимая инфраструктура с Docker Compose, включая Nginx в роли API Gateway.

---
### **Фаза 2: Основная бизнес-логика и функции администратора**

#### **Задачи для `API Service`**

**Задача 3.1: Настроить аутентификацию для администраторов (MVP) [DONE]**
*   **Статус:** Завершено.
*   **Описание:** Вместо сложной системы с JWT, реализована базовая аутентификация (Basic Auth) на уровне Nginx. Учетные данные задаются в `.env` и автоматически применяются при старте контейнера `gateway`. Доступ к эндпоинтам по префиксу `/api/v1/admin/` теперь защищен.

**(Epic) Задача 3.2: Рефакторинг модели `Application` и связанных сущностей**
*   **Описание:** Это ключевая задача, которая изменяет основу хранения данных. Необходимо полностью переработать модели в `api-service` для поддержки новой логики.
*   **Подзадачи:**
    1.  **Изменить Primary Key:** В модели `Application` заменить `id` (Integer) на `id` (UUID). Это необходимо для безопасных "resume" ссылок.
    2.  **Добавить `telegram_id`:** В модель `Application` добавить новое поле `telegram_id` (тип `BigInteger`, `nullable=True`, `unique=True`). Это позволит находить заявку пользователя при его возвращении в бот.
    3.  **Добавить поле для комментариев:** В модель `Application` добавить текстовое поле `admin_comment` (`Text`, `nullable=True`) для заметок сотрудников фонда (MVP-решение).
    4.  **Создать модель для файлов:** Создать новую SQLAlchemy-модель `ApplicationFile` со связью "один ко многим" к `Application`. Поля: `id`, `application_id` (FK), `file_id` (строка, ID из file-storage-service), `original_filename`, `form_field_id` (строка, к какому полю анкеты относится файл).
    5.  **Сгенерировать новые миграции:** Удалить старые миграции Alembic, сгенерировать новую "initial" миграцию со всеми изменениями и очистить базу данных (`docker-compose down -v`).
*   **Критерии готовности:** Модели `Application` и `ApplicationFile` обновлены в `db_models.py`. Новая миграция Alembic создана и успешно применяется.
*   **Зависимости:** Нет. Является блокирующей для задач 3.3 и 3.4.

**Задача 3.3: Реализовать эндпоинты для управления заявками (Админ)**
*   **Описание:** Создать CRUD-эндпоинты для администраторов, которые будут работать с новой моделью `Application` (с UUID). Эти эндпоинты будут доступны через Nginx по пути `/api/v1/admin/applications/...`.
*   **Подзадачи:**
    *   `GET /api/v1/applications`: Получение списка всех заявок. Должен поддерживать пагинацию (`limit`, `offset`) и фильтрацию по статусу.
    *   `GET /api/v1/applications/{app_uuid}`: Получение полной информации по одной заявке, включая связанные файлы и комментарий администратора.
    *   `PATCH /api/v1/applications/{app_uuid}`: Обновление заявки. Позволяет изменять `status` и `admin_comment`.
*   **Критерии готовности:** Все эндпоинты реализованы, работают с UUID и возвращают корректные данные.
*   **Зависимости:** Задача 3.2.

**Задача 3.4: Реализовать публичные эндпоинты для заполнения анкеты**
*   **Описание:** Обновить и создать публичные эндпоинты, которые будет использовать Mini App для сохранения и отправки анкеты.
*   **Подзадачи:**
    *   `GET /api/v1/applications/{app_uuid}`: Получение данных анкеты для возобновления заполнения.
    *   `PATCH /api/v1/applications/{app_uuid}`: Сохранение промежуточного прогресса (обновление поля `data`).
    *   `POST /api/v1/applications/{app_uuid}/files`: Новый эндпоинт для привязки загруженного файла к заявке (создает запись в `ApplicationFile`).
    *   `POST /api/v1/applications/{app_uuid}/submit`: Новый эндпоинт для завершения подачи заявки (меняет статус с `draft` на `new`).
*   **Критерии готовности:** Эндпоинты реализованы и позволяют пользователю полностью пройти сценарий заполнения и отправки анкеты.
*   **Зависимости:** Задача 3.2.

**Задача 4.1: Перенести схему анкеты в базу данных**
*   **Описание:** Уйти от статического `form_schema.json`. Создать модель `FormSchema` в БД. Изменить эндпоинт `GET /api/v1/forms/schema/active`, чтобы он загружал последнюю активную схему из этой таблицы.
*   **Критерии готовности:** Схема анкеты хранится и запрашивается из БД.
*   **Зависимости:** Нет (может выполняться параллельно с 3.3 и 3.4).

---
### **Фаза 3: Интеграция с клиентами и финализация**

**Задача 5.1: Интегрировать `bot-service` с обновленной логикой сессий**
*   **Сервис:** `bot-service`, `api-service`
*   **Описание:** Обновить логику `bot-service` для поддержки возобновляемых сессий.
*   **Подзадачи:**
    1.  **API-Service:** Создать или обновить эндпоинт `POST /api/v1/sessions/telegram`. Он должен принимать `telegram_id`. Если для этого ID есть заявка в статусе `draft`, он возвращает её UUID. Если нет — создает новую, привязывает к `telegram_id` и возвращает её UUID.
    2.  **Bot-Service:** Обновить обработчик `/start`. Он должен вызывать новый эндпоинт из п.1, передавая `telegram_id` пользователя. Полученный UUID используется для формирования URL для Mini App.
*   **Критерии готовности:** Пользователь, возвращающийся в бот, продолжает заполнять свою старую заявку, а не создает новую.
*   **Зависимости:** Задача 3.2, Задача 3.4.