# kanban.md
### **Общая стратегия и параллельная работа**

Основная фаза рефакторинга (**Фаза 2**) завершена. Мы переходим к реализации оставшихся функций MVP, таких как хранение схемы анкеты в БД и добавление конечных точек для веб-сессий и экспорта данных.

---
### **Фаза 1: Реализация базовой логики сервисов [DONE]**

*   **Статус:** Завершено.
*   **Результат:** Настроена базовая микросервисная архитектура (Docker, Nginx). Реализованы начальные версии сервисов, включая полнофункциональный `file-storage-service`.

---
### **Фаза 2: Основная бизнес-логика и функции администратора [DONE]**

*   **Статус:** Завершено.
*   **Результат:** Проведен полный рефакторинг `api-service` для поддержки основного бизнес-процесса.
    *   **Аутентификация администраторов:** Реализована через Nginx Basic Auth.
    *   **Рефакторинг моделей данных:** Модель `Application` переведена на `UUID`, добавлено поле `telegram_id` и создана связанная модель `ApplicationFile`. База данных успешно мигрирована на новую схему.
    *   **Реализация API эндпоинтов:** Созданы все необходимые эндпоинты для администраторов (просмотр, обновление статуса заявок) и для публичного использования Mini App (сохранение прогресса, привязка файлов, отправка анкеты).
    *   **Интеграция с `bot-service`:** Обновлена логика создания сессий. Теперь `bot-service` передает `telegram_id`, что позволяет пользователям возобновлять свои незавершенные заявки.

---
### **Фаза 3: Финальные функции MVP и улучшения**

#### **Задачи для `API Service`**

**[DONE](Epic) Задача 4.1: Перенести схему анкеты в базу данных**
*   **Результат:** Схема анкеты успешно перенесена из статического файла `form_schema.json` в базу данных (таблица `form_schemas`). Реализован публичный эндпоинт для получения активной схемы и эндпоинт для администраторов для загрузки и активации новой версии схемы. Это делает анкету полностью динамической.

**[DONE]Задача 6.1: Реализовать создание сессии для веб-виджета**
*   **Результат:** Реализован эндпоинт `POST /api/v1/sessions/web`. Он создает новую "анонимную" заявку со статусом `draft` (без `telegram_id`) и возвращает ее `application_uuid`. Это позволяет пользователям с сайта начать заполнение анкеты.

**[DONE]Задача 6.2: Реализовать экспорт заявок в XLSX**
*   **Результат:** Создан эндпоинт для администраторов `GET /api/v1/admin/applications/export`. Он извлекает все заявки, "расплющивает" JSON-поле с данными в плоскую структуру и возвращает готовый XLSX-файл. Логика генерации файла вынесена в отдельный сервис.

**[DONE]Задача 6.3: Реализовать скачивание документов заявки ZIP-архивом**
*   **Результат:** Создан эндпоинт `GET /api/v1/admin/applications/{uuid}/download-documents`. `api-service` теперь выступает в роли координатора: получает из БД список файлов заявки, запрашивает у `file-storage-service` временные ссылки на скачивание, загружает по ним файлы в память и упаковывает их в ZIP-архив, который отдает администратору.

**[DONE]Задача 7.1: Добавить базовое логирование**
*   **Описание:** Улучшить наблюдаемость и отладку сервисов путем добавления структурированного логирования.
*   **Результат:** Во все сервисы (`api-service`, `bot-service`, `file-storage-service`) добавлено логирование ключевых операций и ошибок с помощью стандартного модуля `logging`. `print()`-вызовы заменены на информативные сообщения логгера. Теперь в консоли Docker отображаются структурированные логи, что значительно упрощает отладку.

**[DONE]Задача 7.2: Реализовать проверку статуса заявки для пользователя**
*   **Описание:** Дать пользователю возможность узнать текущий статус своей заявки.
*   **Подзадачи (Backend - API Service):**
    1.  Создать эндпоинт `GET /api/v1/sessions/telegram/status`, принимающий `telegram_id` и возвращающий статус последней заявки (`{"status": "..."}`).
    2.  Создать эндпоинт `GET /api/v1/applications/{application_uuid}/public/status` для веб-виджета, который возвращает только статус заявки.
*   **Подзадачи (Frontend - Bot Service):**
    1.  Реализовать обработчик для команды `/status`.
*   **Критерии готовности:** Пользователь может получить актуальный статус своей заявки через Telegram-бот или по прямой ссылке.
*   **Зависимости:** Нет.

### **Фаза 4: Рефакторинг архитектуры (Pragmatic Clean Architecture)**

**[DONE](Epic) Задача 7.3: Внедрить слоистую архитектуру в `api-service`**
*   **Описание:** Провести рефакторинг `api-service` для четкого разделения ответственности между слоями: API (веб), Services (бизнес-логика) и Repositories (доступ к данным). Это повысило тестируемость и упростило дальнейшую разработку.
*   **Подзадачи:**
    1.  **[DONE]** Создать `core/dependencies.py` и внедрить `typing.Annotated` для централизованного управления зависимостями.
    2.  **[DONE]** Создать `ApplicationRepository` и `FormSchemaRepository` в новом каталоге `app/repositories`, перенеся в них всю логику работы с SQLAlchemy.
    3.  **[DONE]** Сделать репозитории "внедряемыми" (dependable) через `core/dependencies.py`.
    4.  **[DONE]** Отрефакторить слой API (`app/api/*`), чтобы он использовал репозитории вместо прямых запросов к БД. Полностью убрать `sqlalchemy` из этого слоя.
    5.  **[DONE]** Отрефакторить `services` (`zip_service`, `export_service`), чтобы они также получали данные через репозитории.
*   **Критерии готовности:** `api-service` имеет четкую трехслойную структуру, и слой API не содержит логики доступа к данным.

### **Фаза 5: Документация**

**[DONE]Задача 8.1: Создать руководство по `form_schema.json`**
*   **Описание:** Подготовить документ на русском языке, объясняющий структуру и все возможные поля JSON-схемы анкеты.
*   **Целевая аудитория:** Менеджеры фонда, которые будут редактировать анкету в будущем.
*   **Содержание:**
    1.  Общая структура: `name`, `version`, `start_step_id`, `steps`.
    2.  Описание объекта "шаг" (`step`): `step_id`, `title`, `fields`, `navigation`.
    3.  Описание объекта "поле" (`field`): `field_id`, `type`, `label`, `required`, `options`.
    4.  Описание логики навигации (`navigation`) и условного отображения полей (`condition`).
*   **Критерии готовности:** Создан понятный `.html` файл с документацией и разда через nginx.
*   **Зависимости:** Нет.

### **Фаза 6: Автоматическое тестирование**

**[TODO](Epic) Задача 9.1: Написать автотесты для `api-service`**
*   **Описание:** Создать набор автоматических тестов для `api-service` с использованием `pytest`, чтобы обеспечить стабильность и предотвратить регрессии. Тесты должны охватывать ключевые компоненты: репозитории, сервисы и API-эндпоинты.
*   **Подзадачи:**
    1.  **[TODO]** Настроить тестовое окружение: создать отдельную тестовую БД, настроить `pytest.ini` и фикстуры для асинхронных тестов.
    2.  **[TODO]** Написать юнит-тесты для репозиториев (`ApplicationRepository`, `FormSchemaRepository`) с использованием in-memory SQLite или тестовой PostgreSQL.
    3.  **[TODO]** Написать интеграционные тесты для API-эндпоинтов, используя `httpx.AsyncClient`. Тесты должны проверять успешные сценарии (2xx), ошибки клиента (4xx) и поведение при некорректных данных.
    4.  **[TODO]** Настроить мокирование (mocking) для внешних зависимостей, таких как `file-storage-service`, чтобы изолировать тесты `api-service`.
    5.  **[TODO]** (Опционально) Интегрировать запуск тестов в CI/CD пайплайн (например, GitHub Actions).
*   **Критерии готовности:** Покрытие тестами ключевой бизнес-логики составляет не менее 70%. Тесты успешно проходят в локальном и CI окружении.

---
---
